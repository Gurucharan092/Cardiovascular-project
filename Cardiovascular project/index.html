<!DOCTYPE html>
<html>
<head>
  <title>Cardiovascular Monitoring Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h2>Heart Rate: <span id="hr">--</span> BPM</h2>
<h2>HRV (RMSSD): <span id="hrv">--</span> ms</h2>

<canvas id="ecgChart" style="max-width: 800px; height: 300px;"></canvas>
<canvas id="hrvChart" style="max-width: 800px; height: 150px; margin-top: 30px;"></canvas>

<script>
  // -------------------------------
  // Firebase Config
  // -------------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyAXqbwhCM0Dr5vZS_pbDlYNcK5fuADdClQ",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    databaseURL: "https://cardio-monitoring-demo-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "cardio-monitoring-demo"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // -------------------------------
  // ECG Chart Setup
  // -------------------------------
  const ecgCtx = document.getElementById("ecgChart").getContext("2d");
  const ecgChart = new Chart(ecgCtx, {
    type: 'line',
    data: {
      labels: Array(100).fill(""),
      datasets: [{
        label: "ECG Signal",
        data: [],
        borderWidth: 1,
        tension: 0.3,
        borderColor: "red",
        fill: false
      }]
    },
    options: {
      animation: false,
      scales: {
        x: { title: { display: true, text: "Samples" }},
        y: { title: { display: true, text: "Amplitude (mV)" }}
      }
    }
  });

  // -------------------------------
  // HRV Chart Setup (Rolling Window)
  // -------------------------------
  const hrvCtx = document.getElementById("hrvChart").getContext("2d");
  const hrvData = {
    labels: [],  // timestamps
    datasets: [{
      label: "HRV (RMSSD ms)",
      data: [],
      borderColor: "blue",
      tension: 0.3,
      fill: false
    }]
  };
  const hrvChart = new Chart(hrvCtx, {
    type: 'line',
    data: hrvData,
    options: {
      animation: false,
      scales: {
        x: { title: { display: true, text: "Time" }},
        y: { title: { display: true, text: "RMSSD (ms)" } }
      }
    }
  });

  const MAX_HRV_POINTS = 50; // rolling window of last 50 updates

  // -------------------------------
  // Firebase Listener
  // -------------------------------
  db.ref("/devices/device_001/live").on("value", snapshot => {
    const data = snapshot.val();
    if (!data) return;

    // Update HR and HRV values
    document.getElementById("hr").innerText = data.heart_rate;
    document.getElementById("hrv").innerText = data.hrv;

    // Update ECG chart
    ecgChart.data.datasets[0].data = data.ecg;
    ecgChart.update();

    // Update HRV rolling chart
    const now = new Date();
    hrvData.labels.push(now.toLocaleTimeString());
    hrvData.datasets[0].data.push(data.hrv);

    if (hrvData.labels.length > MAX_HRV_POINTS) {
      hrvData.labels.shift();
      hrvData.datasets[0].data.shift();
    }

    hrvChart.update();
  });

</script>

</body>
</html>